<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebRTC Test Client</title>
</head>
<body>
  <h1>WebRTC Test Client</h1>
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>
  <script>
    const roomId = "4b4f3ded-6089-4d16-8de6-ef3e9f6dec84";
    const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiIwZGIwY2FhMS1kMTU5LTRhOTYtYWI4OS00NmFhODM3ZDBjNzgiLCJleHAiOjE3NjQzMjI4OTJ9.RMqArAPv_K0MjfbT4te3ltWCGAzPVQpX7UYjMTW7yCg";

    async function start() {
      const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");

      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      stream.getTracks().forEach(track => pc.addTrack(track, stream));
      localVideo.srcObject = stream;

      pc.ontrack = (event) => {
        remoteVideo.srcObject = event.streams[0];
      };

      pc.onicecandidate = async (event) => {
        if (event.candidate) {
          await fetch(`http://localhost:8081/ice?roomId=${roomId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + token
            },
            body: JSON.stringify(event.candidate)
          });
        }
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const resp = await fetch(`http://localhost:8081/webrtc?roomId=${roomId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(pc.localDescription)
      });

      const answer = await resp.json();

      await pc.setRemoteDescription({ type: "answer", sdp: answer.sdp });

      async function pollRemoteICE() {
        const iceResp = await fetch(`http://localhost:8081/ice?roomId=${roomId}`, {
          headers: { "Authorization": "Bearer " + token }
        });
        if (iceResp.ok) {
          const candidates = await iceResp.json();
          if (Array.isArray(candidates)) {
            for (const c of candidates) {
              try {
                await pc.addIceCandidate(c);
              } catch(e) {
                console.warn("Erreur ajout ICE candidate distante:", e);
              }
            }
          }
        }
        setTimeout(pollRemoteICE, 2000);
      }

      pollRemoteICE();
    }

    start();
  </script>
</body>
</html>
