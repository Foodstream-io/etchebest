<!DOCTYPE html>
<html>

<head>
    <title>WebRTC Multi-Stream Room Test</title>
</head>

<body>
    <h1>WebRTC Multi-Stream Room Test</h1>
    <input type="text" id="roomName" placeholder="Enter room name" />
    <button onclick="createRoom()">Create Room</button>
    <button onclick="joinRoom()">Join Room</button>
    <button onclick="leaveRoom()">Leave Room</button>
    <button onclick="toggleSecondStream()">Toggle Second Stream (Screen)</button>

    <h2>Your Streams:</h2>
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="secondStream" autoplay muted playsinline style="display:none;"></video>

    <h2>Remote Streams:</h2>
    <div id="remoteVideos"></div>

    <script>
        let pc;
        const remoteStreams = new Map();
        let roomName = "";
        let roomId = "";
        let secondStreamActive = false;
        let localStream, secondStream;

        async function createRoom() {
            roomName = document.getElementById("roomName").value;
            if (!roomName) return alert("Please enter a room name");

            try {
                const response = await fetch(`https://980f-163-5-3-68.ngrok-free.app/createRoom`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name: roomName })
                });

                const data = await response.json();
                if (!data.roomId) {
                    console.error("Failed to create room");
                    return;
                }

                roomId = data.roomId;
                console.log(`Room created: ${roomId}`);
            } catch (err) {
                console.error("Failed to create room:", err);
            }
        }

        async function joinRoom() {
            roomId = document.getElementById("roomName").value;
            if (!roomId) return alert("Please enter a room ID");

            pc = new RTCPeerConnection({
                iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
            });

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log("New ICE candidate:", event.candidate);
                    fetch(`https://980f-163-5-3-68.ngrok-free.app/ice?roomId=${roomId}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(event.candidate)
                    })
                    .then(response => response.json())
                    .then(data => console.log("ICE candidate sent:", data))
                    .catch(err => console.error("Failed to send ICE candidate:", err));
                } else {
                    console.log("All ICE candidates have been sent");
                }
            };

            pc.oniceconnectionstatechange = () => {
                console.log("ICE connection state:", pc.iceConnectionState);
            };

            pc.onconnectionstatechange = () => {
                console.log("PeerConnection state:", pc.connectionState);
            };

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById("localVideo").srcObject = localStream;
                localStream.getTracks().forEach(track => {
                    console.log(`Adding local track: ${track.kind}`);
                    pc.addTrack(track, localStream)});
            } catch (err) {
                console.error("Failed to get local stream:", err);
                alert("Failed to get local stream: " + err.message);
                return;
            }

            pc.ontrack = (event) => {
                console.log(`Received track: ${event.track.kind}`);
                const stream = event.streams.length > 0 ? event.streams[0] : new MediaStream([event.track]);

                if (!remoteStreams.has(stream.id)) {
                    console.log("New remote stream detected, adding video element");
                    const remoteVideo = document.createElement("video");
                    remoteVideo.srcObject = stream;
                    remoteVideo.autoplay = true;
                    remoteVideo.playsinline = true;
                    document.getElementById("remoteVideos").appendChild(remoteVideo);
                    remoteStreams.set(stream.id, remoteVideo);
                } else {
                    remoteStreams.get(stream.id).srcObject.addTrack(event.track);
                }
            };

            try {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                console.log("Local SDP:", pc.localDescription.sdp);

                const response = await fetch(`https://980f-163-5-3-68.ngrok-free.app/webrtc?roomId=${roomId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sdp: offer.sdp, type: offer.type })
                });

                const data = await response.json();
                if (!data.sdp) {
                    console.error("Failed to get SDP answer");
                    return;
                }

                await pc.setRemoteDescription(new RTCSessionDescription({ type: "answer", sdp: data.sdp }));
                console.log("Remote SDP:", pc.remoteDescription?.sdp);

                console.log(`Joined room: ${roomId}`);
            } catch (err) {
                console.error("Failed to join room:", err);
            }
        }

        async function toggleSecondStream() {
            if (secondStreamActive) {
                secondStream.getTracks().forEach(track => track.stop());
                document.getElementById("secondStream").style.display = "none";
                secondStreamActive = false;
            } else {
                try {
                    secondStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    document.getElementById("secondStream").srcObject = secondStream;
                    document.getElementById("secondStream").style.display = "block";

                    secondStream.getTracks().forEach(track => {
                        console.log(`Adding second stream track: ${track.kind}`);
                        pc.addTrack(track, secondStream);
                    });

                    secondStreamActive = true;
                } catch (err) {
                    console.error("Failed to get second stream:", err);
                    alert("Failed to get second stream: " + err.message);
                }
            }
        }

        async function leaveRoom() {
            if (!roomId || !pc) return;

            try {
                const response = await fetch(`https://980f-163-5-3-68.ngrok-free.app/disconnect?roomId=${roomId}`, { method: "POST" });
                if (!response.ok) {
                    console.error("Failed to disconnect:", await response.text());
                    return;
                }

                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                if (secondStreamActive && secondStream) {
                    secondStream.getTracks().forEach(track => track.stop());
                    document.getElementById("secondStream").style.display = "none";
                    secondStreamActive = false;
                }

                pc.getSenders().forEach(sender => pc.removeTrack(sender));
                pc.close();
                pc = null;
                document.getElementById("localVideo").srcObject = null;
                document.getElementById("remoteVideos").innerHTML = "";
                remoteStreams.clear();
                alert("You have left the room");
            } catch (err) {
                console.error("Failed to leave room:", err);
            }
        }
    </script>

</body>

</html>